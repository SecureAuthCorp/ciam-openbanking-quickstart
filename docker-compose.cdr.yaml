################################################################################
# Add the following to your hosts file, eg C:\Windows\System32\drivers\etc\hosts
#
# 127.0.0.1 mock-data-holder
# 127.0.0.1 mock-data-recipient
# 127.0.0.1 mock-register
#
# Then flush the DNS cache, on Windows use: ipconfig /flushdns
################################################################################

version: '3.0'

services:
  mock-register:
    container_name: mock-register
    image: consumerdataright/mock-register
    volumes:
      - ./mount/cdr/registry-seed.json:/app/admin/Data/seed-data.json
    ports:
      - "7000:7000"
      - "7001:7001"
      - "7005:7005"
      - "7006:7006"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production

  mock-data-holder:
    container_name: mock-data-holder
    image: docker.cloudentity.io/cdr-mock-data-holder:0.0.3
    volumes:
      - ./mount/cdr/holder.json:/app/idsvr/appsettings.Production.json
      - ./mount/cdr/holder-seed.json:/app/manage/Data/seed-data.json
      - ./mount/cdr/mock-data-holder/resource-api-appsettings.json:/app/resource/appsettings.Production.json
    ports:
      - "8000:8000"
      - "8001:8001"
      - "8002:8002"
      - "8003:8003"
      - "8004:8004"
      - "8005:8005"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production

  mock-data-recipient:
    container_name: mock-data-recipient
    image: docker.cloudentity.io/cdr-mock-data-recipient:0.0.6
    networks:
      default:
        aliases:
          - datarecipient.mock
    volumes:
      - ./mount/cdr/recipient.json:/app/web/appsettings.Production.json
    ports:
      - "9001:9001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production

  consent-page:
    image: cloudentity/openbanking-quickstart-consent-page:${VERSION}
    container_name: consent-page
    restart: always
    ports:
      - "7080:8080"
    volumes:
      - ./mount/consent-page:/data
      - ./data/ca.pem:/ca.pem
      - ./data/bank_cert.pem:/bank_cert.pem
      - ./data/bank_key.pem:/bank_key.pem
      - ./data/tpp_cert.pem:/tpp_cert.pem 
      - ./data/tpp_key.pem:/tpp_key.pem
    env_file:
      - .env
    environment:
      - ISSUER_URL=${ACP_MTLS_URL}/${TENANT}/system
      - LOG_LEVEL=debug
      - SPEC=cdr
      - GIN_MODE=debug # change to release to disable gin debug
      - OTP_MODE=mock # change to custom to enable custom OTP handling
      - MFA_CLAIM=sub # for mobile use mobile_verified
      
      - BANK_URL=http://bank:8070
      - BANK_CLIENT_TOKEN_URL=${ACP_URL}/${TENANT}/cdr/oauth2/token
      - BANK_CLIENT_ID=cw1ocudfotn6edhsiv8h 
      - BANK_CLIENT_SECRET=pMPBmv62z3Jt1S4sWl2qRhOhEGPVZ9EcujGL7Xy0-E0 
      - BANK_CLIENT_SCOPES=bank:accounts.basic:read,bank:accounts.detail:read
      - BANK_CLIENT_CERT_FILE=/tpp_cert.pem
      - BANK_CLIENT_KEY_FILE=/tpp_key.pem

    depends_on:
      configuration:
        condition: service_completed_successfully

  consent-self-service-portal:
    image: cloudentity/openbanking-quickstart-consent-self-service-portal:${VERSION}
    container_name: consent-self-service-portal
    restart: always
    ports:
      - "8085:8085"
    env_file:
      - .env
    volumes:
      - ./data/ca.pem:/ca.pem
      - ./data/bank_cert.pem:/bank_cert.pem
      - ./data/bank_key.pem:/bank_key.pem
    environment:
      - SYSTEM_ISSUER_URL=${ACP_MTLS_URL}/${TENANT}/system
      - BANK_URL=http://bank:8070
      - LOGIN_AUTHORIZATION_SERVER_URL=${ACP_URL}
      - LOGIN_AUTHORIZATION_SERVER_ID=bank-customers
      - LOGIN_TENANT_ID=${TENANT}
      - INTROSPECT_ISSUER_URL=${ACP_MTLS_URL}/${TENANT}/bank-customers
      - OPENBANKING_SERVER_ID=cdr
      - SPEC=cdr
    depends_on:
      configuration:
        condition: service_completed_successfully


  consent-admin-portal:
    image: cloudentity/openbanking-quickstart-consent-admin-portal:${VERSION}
    container_name: consent-admin-portal
    restart: always
    ports:
      - "8086:8086"
    volumes:
      - ./data/ca.pem:/ca.pem
      - ./data/bank_cert.pem:/bank_cert.pem
      - ./data/bank_key.pem:/bank_key.pem
    environment:
      - SYSTEM_ISSUER_URL=${ACP_MTLS_URL}/${TENANT}/system
      - OPENBANKING_WORKSPACE_ID=cdr
      - SPEC=cdr
      - INTROSPECT_ISSUER_URL=${ACP_MTLS_URL}/${TENANT}/bank-admins
    depends_on:
      configuration:
        condition: service_completed_successfully

  configuration:
    container_name: configuration
    image: cloudentity/openbanking-quickstart-configuration:latest
    restart: on-failure
    volumes:
      - ./data/tpp_cert.pem:/certs/tpp_cert.pem
      - ./data/ca.pem:/certs/ca.pem
      - ./data/variables.yaml:/variables.yaml
      - ./data/imports/system.tmpl:/app/imports-cdr/system.tmpl
      - ./data/imports/bank-customers.tmpl:/app/imports-cdr/bank-customers.tmpl
      - ./data/imports/cdr.tmpl:/app/imports-cdr/cdr.tmpl
    command:
      - /app/main
      - --tenant-url
      - ${CONFIGURATION_TENANT_URL}
      - --tenant
      - ${CONFIGURATION_TENANT}
      - --client-id
      - ${CONFIGURATION_CLIENT_ID}
      - --client-secret
      - ${CONFIGURATION_CLIENT_SECRET}
      - --templates-dirs
      - /app/imports-cdr
      - --variables-file
      - /variables.yaml
      - --verbose  
